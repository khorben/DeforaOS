#$Id$
#Copyright (c) 2009 Pierre Pronchery <khorben@defora.org>



#variables
[ -z "$FDISK" ]		&& FDISK="fdisk"
[ -z "$INSTALLBOOT" ]	&& INSTALLBOOT="installboot"
[ -z "$MBRLABEL" ]	&& MBRLABEL="mbrlabel"
[ -z "$MKFS" ]		&& MKFS="newfs"
[ -z "$MOUNT" ]		&& MOUNT="mount"
[ -z "$UMOUNT" ]	&& UMOUNT="umount"
[ -z "$VNCONFIG" ]	&& VNCONFIG="vnconfig"
[ -z "$VND" ]		&& VND="vnd0"


#functions
#private
#image_image
_image_image()
{
	USAGE="Options for $IMAGE_TYPE on $TARGET:\n\
  IMAGE_FILE	Where to write the filesystem image\n\
  IMAGE_KERNEL	Path to the kernel\n\
  IMAGE_SIZE	Size of the filesystem image in kilobytes\n\
  MKFS		Command used to format the filesystem"

	#sanity check
	check "$USAGE" DD DESTDIR DEVZERO FDISK IMAGE_FILE IMAGE_KERNEL \
		IMAGE_SIZE INSTALLBOOT MBRLABEL MKDIR MKFS MOUNT UMOUNT \
		VNCONFIG VND

	$MKDIR "$DESTDIR"					|| exit 2
	$UMOUNT "$DESTDIR"
	$VNCONFIG -u "$VND"
	$DD if="$DEVZERO" of="$IMAGE_FILE" count="$IMAGE_SIZE" &&
	$FDISK -Ffi "$IMAGE_FILE"				|| exit 2
	SIZE=$((IMAGE_SIZE - 63))
	$FDISK -Ffu0s "169/63/$SIZE" "$IMAGE_FILE"		|| exit 2
	$FDISK -Ffa0 "$IMAGE_FILE"				|| exit 2
	$VNCONFIG -c "$VND" "$IMAGE_FILE"			|| exit 2
	$MBRLABEL -frw "$VND"					&&
	$MKFS "${VND}e"						&&
	$MOUNT "/dev/${VND}e" "$DESTDIR"			&&
	target "install"					&&
	$MKDIR "$DESTDIR/bin"					&&
	$MV "$DESTDIR$PREFIX/bin/sh" "$DESTDIR/bin/sh"		&&
	$MKDIR "$DESTDIR/dev"					&&
	$MKNOD -m 600 "$DESTDIR/dev/console" c 0 0		&&
	$MKDIR "$DESTDIR/libexec" "$DESTDIR/usr/libexec"	&&
	$INSTALL -m 555 "/libexec/ld.elf_so" "$DESTDIR/libexec"	&&
	$LN -s "/libexec/ld.elf_so" "$DESTDIR/usr/libexec"	&&
	$MKDIR "$DESTDIR/sbin"					&&
	SUBDIRS="Apps/Unix/src/others/tools" target oinit	&&
	$INSTALL -m 755 "Apps/Unix/src/others/tools/oinit"	\
			"$DESTDIR/sbin/init"			&&
	$INSTALL -m 644 "/usr/mdec/boot" "$DESTDIR/boot"	&&
	$INSTALL -m 755 "$IMAGE_KERNEL" "$DESTDIR/netbsd"	&&
	$INSTALLBOOT -m "$MACHINE" "/dev/r${VND}e" /usr/mdec/bootxx_ffsv1
	RET=$?
	$UMOUNT "$DESTDIR"
	$VNCONFIG -u "$VND"
	return $RET
}


#image_iso
_image_iso()
{
	USAGE="Options for $IMAGE_TYPE on $TARGET:\n\
  IMAGE_FILE	Where to write the filesystem image\n\
  IMAGE_KERNEL	Path to the kernel"
	MAKEFS="makefs -t cd9660"
	MAKEFS_ARGS="-o bootimage=i386;/usr/mdec/bootxx_cd9660,no-emul-boot"

	#sanity check
	check "$USAGE" IMAGE_FILE IMAGE_KERNEL
	target "install"					|| exit 2
	$MKDIR "$DESTDIR/dev"					|| exit 2
	$SUDO $MKNOD -m 600 "$DESTDIR/dev/console" c 0 0	|| exit 2
	$MKDIR "$DESTDIR/libexec" "$DESTDIR/usr/libexec"	|| exit 2
	$INSTALL -m 555 "/libexec/ld.elf_so" "$DESTDIR/libexec"	|| exit 2
	$LN -s "/libexec/ld.elf_so" "$DESTDIR/usr/libexec"	|| exit 2
	$MKDIR "$DESTDIR/sbin"					|| exit 2
	SUBDIRS="Apps/Unix/src/others/tools" target oinit	|| exit 2
	$INSTALL -m 755 "Apps/Unix/src/others/tools/oinit"	\
			"$DESTDIR/sbin/init"			|| exit 2
	$INSTALL -m 755 "$IMAGE_KERNEL" "$DESTDIR/netbsd"	|| exit 2
	$INSTALL -m 644 "/usr/mdec/boot" "$DESTDIR/boot"	|| exit 2
	$MAKEFS $MAKEFS_ARGS "$IMAGE_FILE" "$DESTDIR"		|| exit 2
}
