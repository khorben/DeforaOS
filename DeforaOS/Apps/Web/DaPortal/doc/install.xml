<?xml version="1.0" encoding="iso-8859-15"?>
<!-- $Id$ -->
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook V4.5//EN"
"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
	<!ENTITY firstname "Pierre">
	<!ENTITY surname   "Pronchery">
	<!ENTITY email     "khorben@defora.org">
	<!ENTITY section   "1">
	<!ENTITY package   "DaPortal">
	<!ENTITY name      "daportal">
	<!ENTITY title     "DaPortal Administrator Manual">
	<!ENTITY purpose   "Installation notes for DaPortal">
]>
<article>
	<info>
	<title>Installing &package;</title>
	<productname>&package;</productname>
	<authorgroup>
		<author>
			<personname><firstname>&firstname;</firstname><surname>&surname;</surname></personname>
			<contrib>Code and documentation.</contrib>
			<address><email>&email;</email></address>
		</author>
	</authorgroup>
	<copyright>
		<year>2012</year>
		<holder>&firstname; &surname; &lt;&email;&gt;</holder>
	</copyright>
	<legalnotice>
		<para>This guide was written for the DeforaOS project (and may be used by
			others).</para>
		<para>Permission is granted to copy, distribute and/or modify this document
			under the terms of the GNU General Public License, Version 3 as published by
			the Free Software Foundation.</para>
	</legalnotice>
	<publisher><publishername>The DeforaOS Project</publishername></publisher>
</info>
<warning>
	<title>Warning: work in progress</title>
	<para>These notes are based on a development version of &package; 2.</para>
</warning>
<section>
	<title>Requirements</title>
	<para>&package; 2 is based on a modular architecture, and therefore able to
		adapt to a number of different environments. The common requirements are:
		<itemizedlist>
			<listitem><para>PHP 5.0 or later:<itemizedlist>
						<listitem><para><ulink
									url="http://www.php.net/">http://www.php.net/</ulink></para></listitem>
						<listitem><para>the Suhosin patch and extension (recommended), <ulink
									url="http://www.hardened-php.net/suhosin/">http://www.hardened-php.net/suhosin/</ulink></para></listitem>
						<listitem><para>optionally, the gettext extension for PHP (if not
								builtin)</para></listitem>
			</itemizedlist></para></listitem>
				<listitem><para>a SQL database backend; either:<itemizedlist>
							<listitem><para>PDO, now standard in PHP;</para></listitem>
							<listitem><para>SQLite, <ulink
										url="http://www.sqlite.org/">http://www.sqlite.org/</ulink></para></listitem>
							<listitem><para>PostgreSQL, <ulink
										url="http://www.postgresql.org/">http://www.postgresql.org/</ulink></para></listitem>
							<listitem><para>or MySQL, <ulink
										url="http://www.mysql.org/">http://www.mysql.org/</ulink> (with known
									issues)</para></listitem>
						</itemizedlist>
					</para></listitem>
				</itemizedlist>
			</para>
			<para>Then, depending on the desired user-interface:<itemizedlist>
					<listitem><para>a web server supporting PHP, like:<itemizedlist>
								<listitem><para>Apache, <ulink
											url="http://httpd.apache.org/">http://httpd.apache.org/</ulink></para></listitem>
					</itemizedlist></para></listitem>
					<listitem><para>or the Gtk+ extension for PHP: <ulink
								url="http://gtk.php.net/">http://gtk.php.net/</ulink></para></listitem>
							<listitem><para>or PHP compiled with support for command-line
									interaction;</para></listitem>
							<listitem><para>the POSIX extension for PHP (if not
									builtin)</para></listitem>
						</itemizedlist>
					</para>
					<para>The following optional components will likely improve the behavior of
						&package;:<itemizedlist>
							<listitem><para>the GNU Gettext extension for PHP (if not
									builtin)</para></listitem>
							<listitem><para>the shared-mime-info package from the freedesktop
									project;</para></listitem>
							<listitem><para>either one of the GNOME, Tango or XFCE4 icon
									themes.</para></listitem>
					</itemizedlist></para>
					<para>Please make sure that your system supports the desired combination of
						components. Install and configure them accordingly before attempting to
						install &package;.</para>
					<para>Then, make sure that you have downloaded the latest stable version of
						&package; 2. It can be found there: <ulink
							url="http://www.defora.org/os/project/download/12/DaPortal">http://www.defora.org/os/project/download/12/DaPortal</ulink>.</para>
					<para>This guide will assume the resulting archive to be called
						<filename>DaPortal.tar.gz</filename>. It will also assume that the current
						user will already have sufficient privileges to install &package; 2 to the
						desired directory; it is otherwise up to the reader to obtain and use
						these privileges when necessary.</para>
					<para>Alternatively, you may choose to track the development of &package;
						2, or any given branch from the Source Code Management system. Some
						instructions to do so can be found here: <ulink
							url="http://www.defora.org/os/project/download/12/DaPortal">http://www.defora.org/os/project/download/12/DaPortal</ulink>.</para>
				</section>
				<section>
					<title>Deployment</title>
					<section>
						<title>Deployment as a web application</title>
						<para>Although primarily tested with the Apache HTTP server, &package; 2
							should work on most web servers supporting PHP.</para>
						<para>For increased security, &package; 2 is meant to be installed in a
							separate directory, outside of the web server's document root folder. On
							most systems, this might be:<itemizedlist>
								<listitem><para><filename>/var/www/daportal</filename> for &package;
										2;</para></listitem>
								<listitem><para><filename>/var/www/htdocs</filename> for the web
										server's document root.</para></listitem>
							</itemizedlist></para>
							<para>To uncompress &package; 2, one would typically enter the following
								commands:</para>
							<programlisting>$ mkdir /var/www/daportal
$ cd /var/www/daportal
$ tar xzvf DaPortal.tar.gz
$ mv DaPortal-*/* .
$ rmdir DaPortal-*</programlisting>
<para>You can then move, copy or alias the contents of the
	<filename>data</filename> folder in the desired location of the web server's
	document root folder. For Apache, this might be as following in <xref
		linkend="example-apache"/>.</para>
<example id="example-apache">
	<title>Data directory aliasing in Apache</title>
	<programlisting>Alias /css/ "/var/www/daportal/data/css/"
Alias /icons/ "/var/www/daportal/data/icons/"
Alias /js/ "/var/www/daportal/data/js/"
Alias /themes/ "/var/www/daportal/data/themes/"</programlisting>
</example>
<para>Likewise, you may have to copy and modify the default index file,
	<filename>index.php</filename>, from the <filename>data</filename> directory to
	the document root. An example of such a file is found in <xref
		linkend="example-index.php"/>:</para>
<example id="example-index.php">
	<title>index.php in the document root</title>
	<programlisting>&lt;?php if(chdir('/var/www/daportal/src')) require('./daportal.php'); ?&gt;</programlisting>
</example>
<para>Alternatively, on most web servers it should be fine to serve &package;'s
	own <filename>data</filename> folder as the actual document root.</para>
</section>
<section>
	<title id="deployment-cli">Deployment as a command-line application</title>
	<para>&package; provides a dedicated command-line utility, <ulink
			url="daportal.html"><command>daportal</command></ulink>, to issue requests to
		the system directly.</para>
	<para>It can be installed to the system as follows:</para>
	<programlisting>$ cd /var/www/daportal/tools
$ make PREFIX="/usr/local" install</programlisting>
<para>Specifying the <varname>PREFIX</varname> value is optional, and defaults
	to <filename>/usr/local</filename>.</para>
<para>It may be necessary to help the <command>daportal</command> script to
	locate the folder where &package; is installed; if available, the configuration
	file <filename>$PREFIX/etc/daportal.conf</filename> will automatically be read.
	An example for this file is provided in <xref
		linkend="example-etc/daportal.conf"/> below:</para>
<example id="example-etc/daportal.conf">
	<title>Example of configuration file in $PREFIX/etc/daportal.conf</title>
	<programlisting>DAPORTALDIR=/var/www/daportal</programlisting>
</example>
</section>
<section>
	<title>Deployment as a Gtk+ application</title>
	<para>&package; 2 can also be used as a Gtk+ application. This requires the
		installation and configuration of the "php-gtk" extension. The
		instructions found in <xref linkend="deployment-cli"/> otherwise apply.</para>
</section>
</section>
<section>
	<title>Configuration</title>
	<para>Depending on how it was invoked (from within PHP), &package; will try to
		automatically guess the backend engine to use. This can otherwise be enforced
		in the <ulink
			url="daportal.conf.html"><filename>daportal.conf</filename></ulink> file,
		located in the root folder of &package;'s own installation folder.</para>
<section>
	<title>Configuration as a web application</title>
	<para>The HTTP engine should be installed and selected automatically. Otherwise
		(or for performance reasons) you can force the backend by modifying the
		<varname>engine</varname> section as follows:</para>
	<programlisting>[engine]
backend=http</programlisting>
	<para>The top-level <varname>theme</varname> and <varname>title</varname>
		settings can be changed as well, and will respectively define the default CSS
		to use (among the <filename>themes</filename> folder), and the default title
		for the web pages and documents generated.</para>
	<para>Alternatively, &package;'s HTTPFriendly engine can be selected. It can
		generate and handle HTTP links and requests that will typically be more
		readable, while also allowing better indexing of the different pages (eg for
		SEO, Search Engine Optimization). If available, it will normally take
		precedence over the default HTTP engine. It requires additional parameters to
		be fully enabled, illustrated here:</para>
	<programlisting>[engine]
backend=httpfriendly

[engine::httpfriendly]
kicker=somename</programlisting>
	<para>There are additional requirements for this configuration to work
		properly:<itemizedlist>
			<listitem><para>an additional handler needs to be placed in the document
					root;</para></listitem>
			<listitem><para>the web server needs to recognize this handler, and pass
					incoming requests through it.</para></listitem>
	</itemizedlist></para>
	<para>An example of such a handler is provided in <xref
			linkend="example-friendly-handler"/>; in this case, it should be named
		<filename>somename.php</filename> and placed in the document root:</para>
	<example id="example-friendly-handler">
		<title>Handler for friendly links</title>
		<programlisting>&lt;?php
$_SERVER['SCRIPT_NAME'] = '/index.php';
if(chdir('/var/www/daportal/src')) require('./daportal.php');
?></programlisting>
</example>
<para>In the case of Apache, the following modification to the configuration for
	the document root may be necessary:</para>
<programlisting>&lt;Directory "/var/www/htdocs"&gt;
	Options MultiViews
	MultiviewsMatch Handlers
&lt;/Directory&gt;
</programlisting>
</section>
<section>
	<title>Configuration of the database backend</title>
	<para>Similarly, the database backend to use must be specified in the
		<varname>database</varname> section, as follows:</para>
	<programlisting>[database]
backend=sqlite2</programlisting>
	<para>Additional parameters may have to be specified; see the respective
		database sections and documentation for reference.</para>
	<para>Example: In the case of SQLite 2, a database file can be created in
		<filename>/var/www/sqlite</filename>, as follows:</para>
	<programlisting>$ mkdir /var/www/sqlite
$ touch /var/www/sqlite/daportal.db
$ sqlite /var/www/sqlite/daportal.db
sqlite&gt; .read /var/www/daportal/doc/sql/sqlite.sql
sqlite&gt; .quit</programlisting>
<para>It can then be configured this way within
	<filename>daportal.conf</filename>:</para>
<programlisting>[database::sqlite2]
filename=/var/www/sqlite/daportal.db</programlisting>
<warning>
	<title>Warning: privileges for the SQLite database folder</title>
	<para>Make sure that the web server has sufficient privileges to read and write
		to this database as required. In the case of SQLite, this often applies to the
		directory containing the database file itself (eg for locking).</para>
</warning>
</section>
<section>
	<title>Configuration of translations</title>
	<para>The user interface for &package; supports multiple languages through the
		GNU Gettext PHP extension. For this to work, the locale database for &package;
		must be installed; this can be done as follows:</para>
	<programlisting>$ cd /var/www/daportal/po
$ make install</programlisting>
	<para>By default, &package; uses translation files from the current locale (if
		available). It can otherwise be forced in <filename>daportal.conf</filename>,
		as shown in <xref linkend="example-locale"/>:</para>
<example id="example-locale">
	<title>Locale settings in daportal.conf</title>
	<programlisting>[defaults]
#for French
locale=fr_FR</programlisting>
</example>
</section>
<section>
	<title>Additional configuration values</title>
	<para>The default configuration file also lists additional settings that may be
		applied to specific components. Please refer to <ulink
			url="daportal.conf.html">its documentation</ulink> for more
		information.</para>
</section>
</section>
</article>
<!-- vim: set noet ts=1 sw=1 sts=1 tw=80: -->
